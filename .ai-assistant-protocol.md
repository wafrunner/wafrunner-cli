# AI Assistant Protocol - Preventing Functionality Loss

## Critical Incident Summary

**Date**: October 29, 2024
**Issue**: During rebase conflict resolution, the `refine-graph` command was accidentally removed from `wafrunner_cli/commands/research.py`
**Impact**: Existing user functionality was temporarily lost
**Resolution**: Command was restored after detection

## Root Cause

During interactive rebase conflict resolution:

1. Conflict occurred between new `init-scdef` code and existing `refine-graph` code
2. Resolution incorrectly replaced `refine-graph` with `init-scdef`
3. No verification was performed that all existing commands were preserved
4. Tests for `refine-graph` passed but didn't catch the missing command definition

## Safeguards Now in Place

### 1. Mandatory Command Verification Script

**Location**: `scripts/verify-commands.sh`
**Purpose**: Verify all required commands exist before any commit
**Usage**: Run automatically or manually after conflict resolution

**Required Commands** (must always be present):

- `github`
- `scrape`
- `classify`
- `init-graph`
- `refine-graph` ⚠️ (previously removed - critical)
- `init-scdef` (new)
- `update-source`
- `links`

### 2. Conflict Resolution Protocol

**Before resolving ANY merge conflict:**

1. ✅ List all existing commands in the file
2. ✅ Check conflict markers for any mention of existing commands
3. ✅ Create a checklist of commands that must be preserved
4. ✅ Verify with: `grep -n "@app.command" <file>`

**During conflict resolution:**

1. ⚠️ **NEVER** remove code from existing commands
2. ⚠️ **ONLY** add new code, never replace existing functionality
3. ⚠️ If unsure, **ASK the user** before making changes

**After resolving conflicts:**

1. ✅ Run: `./scripts/verify-commands.sh`
2. ✅ Run all tests: `pytest tests/`
3. ✅ Verify command list matches baseline
4. ✅ **Show diff to user** if ANY existing commands were modified
5. ✅ Get explicit approval before committing

### 3. Code Review Checklist

Before committing ANY changes that touch command definitions:

- [ ] All existing `@app.command` decorators are present
- [ ] No existing command functions were deleted
- [ ] Command verification script passes
- [ ] All tests pass (especially tests for existing commands)
- [ ] Diff shows no removals of existing functionality
- [ ] User has been informed of any changes to existing code

### 4. Automated Checks

The verification script should be run:

- Before every commit that modifies command files
- After resolving merge conflicts
- In pre-commit hooks (recommended)

## User Communication Protocol

**When encountering conflicts with existing code, MUST:**

1. Stop and inform the user
2. Show what conflicts involve existing functionality
3. Ask for guidance on how to proceed
4. Never assume - always confirm

**Template message:**

```
⚠️ CONFLICT WARNING: Merge conflicts detected that may affect existing functionality.

Existing commands at risk:
- [list commands]

Conflicts in: [file:line ranges]

Options:
1. I can show you the conflicts and you resolve manually
2. You guide me through the resolution step-by-step
3. I propose a resolution and you approve before I commit

How would you like to proceed?
```

## Testing Protocol

After ANY merge conflict resolution:

1. Run full test suite: `pytest tests/`
2. Specifically test affected commands if they have tests
3. Verify command registration: Run verification script
4. Check CLI help: `python -m wafrunner_cli.main research --help`

## Emergency Response

If functionality is accidentally removed:

1. **STOP immediately** - do not continue
2. **Inform user** - explain what happened
3. **Restore from git history**: `git show <commit>:<file>` to get original
4. **Verify restoration** - run verification script
5. **Test thoroughly** - ensure functionality restored
6. **Commit fix** - add commit message explaining what was fixed

## Lessons Learned

1. **Never modify existing commands** without explicit user approval
2. **Always verify** after conflict resolution
3. **Automate checks** - use scripts to catch mistakes
4. **When in doubt, ask** - better to be cautious than break things
5. **Existing functionality is sacred** - additions only, never removals

## Future Improvements

1. Add verification script to pre-commit hooks
2. Create unit test that verifies all commands exist
3. Add git hook to prevent commits if verification fails
4. Document all commands in a central registry
5. Add integration tests that actually invoke each command
