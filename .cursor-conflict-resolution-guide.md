# Conflict Resolution Safety Guidelines

## CRITICAL RULES - NEVER VIOLATE

### Rule 1: Never Remove Existing Commands/Functions

- **NEVER** delete or modify existing user-facing commands (`@app.command` functions)
- **NEVER** remove functionality that users depend on
- **ALWAYS** preserve existing commands exactly as they are

### Rule 2: Conflict Resolution Protocol

When resolving merge conflicts:

1. **Identify ALL existing commands first:**

   ```bash
   git diff origin/main --name-only
   grep -n "@app.command" <file-being-merged>
   ```

2. **Verify preservation:**

   - List all commands in BOTH versions (incoming and current)
   - Ensure every existing command is present in the resolved version
   - If ANY command is missing, STOP and ask the user

3. **Before resolving conflicts:**

   - Create a checklist of existing commands
   - Verify each one after resolution

4. **After resolving conflicts:**
   - Run: `python -c "from wafrunner_cli.commands.research import app; print([c.name for c in app.registered_commands if c.name])"`
   - Compare against the baseline list
   - Run existing tests to ensure nothing broke

### Rule 3: Mandatory Validation Steps

Before committing ANY merge conflict resolution:

1. ✅ Run all existing tests: `pytest tests/`
2. ✅ Verify all commands are present (checklist comparison)
3. ✅ Run flake8 to ensure code quality
4. ✅ Show the user a diff of what changed in existing commands
5. ✅ Get explicit approval if ANY existing functionality changed

### Rule 4: When in Doubt, ASK

- If conflict involves existing code: ASK the user
- If unsure about what to keep: ASK the user
- If existing command appears modified: ASK the user
- Never assume - always confirm

## Command Preservation Checklist

When working on research.py, verify these commands exist after ANY change:

- [ ] `github`
- [ ] `scrape`
- [ ] `classify`
- [ ] `init-graph`
- [ ] `refine-graph` ⚠️ (Was accidentally removed - verify this always exists)
- [ ] `init-scdef` (new)
- [ ] `update-source`
- [ ] `links`

## Automated Check Script

Use this before committing:

```bash
#!/bin/bash
# verify-commands.sh
python3 -c "
from wafrunner_cli.commands.research import app
commands = sorted([c.name for c in app.registered_commands if c.name])
required = ['github', 'scrape', 'classify', 'init-graph', 'refine-graph', 'init-scdef', 'update-source', 'links']
missing = set(required) - set(commands)
if missing:
    print(f'ERROR: Missing commands: {missing}')
    exit(1)
print('All required commands present')
"
```

## Response Template for Conflict Resolution

When encountering conflicts with existing code, ALWAYS respond:

"I've detected merge conflicts that may affect existing functionality. Before proceeding:

1. Current existing commands: [list them]
2. Conflicts in: [file:line]
3. Proposed resolution: [explain]
4. Risk to existing commands: [assessment]

Please confirm how you'd like me to proceed, or if you prefer to resolve this manually."
